@startuml 智能调度空间时序图
actor 用户
participant 可视化界面
participant 可视化服务
participant 空间状态管理器
participant 空间类
participant 智能推荐引擎
participant 预约规则类
participant 预约订单类
participant 门禁集成模块
participant 门禁系统
actor 管理员

' 场景1：可视化状态展示
用户 -> 可视化界面: 查看空间状态（校区/楼层/类型）
可视化界面 -> 可视化服务: 请求生成状态列表
可视化服务 -> 空间状态管理器: 按条件查询状态
空间状态管理器 -> 空间类: 批量查询信息
空间类 -> 空间状态管理器: 返回状态集合（响应）
空间状态管理器 -> 可视化服务: 返回状态数据（响应）
可视化服务 -> 可视化界面: 渲染状态列表（响应）

用户 -> 可视化界面: 查看楼层热力图
可视化界面 -> 可视化服务: 请求生成热力图数据
可视化服务 -> 空间状态管理器: 查询时段使用记录
空间状态管理器 -> 空间类: 批量查询使用历史
空间类 -> 空间状态管理器: 返回使用记录（响应）
空间状态管理器 -> 可视化服务: 返回热力图数据源（响应）
可视化服务 -> 可视化界面: 渲染热力图（响应）

' 场景2：智能推荐与预约
用户 -> 可视化界面: 提交预约需求（容量/设施/时段）
可视化界面 -> 智能推荐引擎: 请求推荐空间
智能推荐引擎 -> 空间状态管理器: 查询空闲空间（时段）
空间状态管理器 -> 空间类: 批量查询状态
空间类 -> 空间状态管理器: 返回空闲空间（响应）
空间状态管理器 -> 智能推荐引擎: 返回空闲数据（响应）
智能推荐引擎 -> 预约规则类: 查询适用规则
预约规则类 -> 智能推荐引擎: 返回规则约束（响应）
智能推荐引擎 -> 可视化界面: 返回推荐列表（响应）
用户 -> 可视化界面: 选择空间并提交预约
可视化界面 -> 预约订单类: 创建订单（用户/空间/时段）
预约订单类 -> 空间状态管理器: 申请锁定状态（待审核）
空间状态管理器 -> 空间类: 更新状态为“待审核”
空间类 -> 空间状态管理器: 状态更新确认（响应）
空间状态管理器 -> 预约订单类: 锁定确认（响应）
预约订单类 -> 可视化界面: 订单创建成功（待审核，响应）

' 场景3：门禁授权（审核通过后）
管理员 -> 预约订单类: 审核通过订单
预约订单类 -> 门禁集成模块: 请求生成门禁授权
门禁集成模块 -> 门禁系统: 调用授权接口（订单/门禁ID）
门禁系统 -> 门禁集成模块: 返回授权ID（响应）
门禁集成模块 -> 预约订单类: 关联授权ID（响应）
预约订单类 -> 用户: 推送预约成功通知（含授权，响应）

' 场景4：门禁验证
用户 -> 门禁系统: 刷卡/扫码验证
门禁系统 -> 门禁集成模块: 验证用户权限（用户/门禁ID）
门禁集成模块 -> 预约订单类: 查询授权有效性
预约订单类 -> 门禁集成模块: 返回授权有效（时段内，响应）
门禁集成模块 -> 门禁系统: 权限验证通过（响应）
门禁系统 -> 用户: 门禁开启（响应）

' 场景5：预约结束后门禁回收
预约订单类 -> 门禁集成模块: 预约结束，请求回收权限
门禁集成模块 -> 门禁系统: 调用回收接口（授权ID）
门禁系统 -> 门禁集成模块: 回收确认（响应）
门禁集成模块 -> 预约订单类: 回收完成（响应）
预约订单类 -> 空间状态管理器: 释放状态为“空闲”
空间状态管理器 -> 空间类: 更新状态为“空闲”
空间类 -> 空间状态管理器: 状态更新确认（响应）
@enduml